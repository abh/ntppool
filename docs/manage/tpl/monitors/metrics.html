[%# Reusable metrics display components %]

[%# Define metric types for DRY iteration %]
[% BLOCK define_metric_types %]
  [% metric_types = [
    { key = 'ok', label = 'ok', always_show = 1 },
    { key = 'timeout', label = 'timeout', always_show = 0 },
    { key = 'offset', label = 'offset', always_show = 0 },
    { key = 'signature_validation', label = 'signature', always_show = 0 },
    { key = 'batch_out_of_order', label = 'batch', always_show = 0 }
  ] %]
  [% time_periods = [
    { key = 'metrics_1h', label = '1 hour' },
    { key = 'metrics_24h', label = '24 hours' }
  ] %]
[% END %]

[%# Format metric breakdown components with conditional display %]
[% BLOCK format_metric_components %]
  [% PROCESS define_metric_types %]
  ([%
    components = [];
    FOREACH type IN metric_types;
      value = period_data.${type.key} || 0;
      IF type.always_show || value > 0;
        components.push(value.format('%.1f') _ ' ' _ type.label);
      END;
    END;
    components.join(', ');
  %])
[% END %]

[%# Format single time period with total and breakdown %]
[% BLOCK format_time_period %]
  <strong>[% period.label %]:</strong> [% (period_data.total || 0) | format('%.1f') %] tests/min
  [% PROCESS format_metric_components %]
[% END %]

[%# Display account totals - works for both regular and admin views %]
[% BLOCK account_totals %]
  [% totals = metrics.data.account_totals || (metrics.data.accounts.item(mon.Account.IDToken)) %]
  [% IF totals && totals.tests_per_minute_1h.total > 0 %]
    <div class="alert alert-info mb-3">
      <small>
        [% PROCESS metrics_breakdown
           metrics_1h = totals.tests_per_minute_1h
           metrics_24h = totals.tests_per_minute_24h
           detailed = 1
        %]
      </small>
    </div>
  [% END %]
[% END %]

[%# Display monitor metrics as list item %]
[% BLOCK monitor_metrics %]
  [% IF metrics && metrics.success && metrics.data.monitors %]
    [% mon_key = mon.TLSName %]
    [% mon_metrics = metrics.data.monitors.$mon_key %]
    [% IF mon_metrics && (mon_metrics.tests_per_minute_1h.total || mon_metrics.tests_per_minute_1h) > 0 %]
      [% IF show_details %]
        <li class="list-group-item">
          <small><strong>Metrics</strong></small><br>
          <small>
            [% PROCESS metrics_breakdown
               metrics_1h = mon_metrics.tests_per_minute_1h
               metrics_24h = mon_metrics.tests_per_minute_24h
               detailed = 1
            %]
          </small>
        </li>
      [% ELSE %]
        <li class="list-group-item">
          <small>
            <strong>Tests/min:</strong>
            [% PROCESS metrics_breakdown
               metrics_1h = mon_metrics.tests_per_minute_1h
               metrics_24h = mon_metrics.tests_per_minute_24h
               detailed = 0
            %]
          </small>
        </li>
      [% END %]
    [% END %]
  [% END %]
[% END %]

[%# Display metrics breakdown - handles both detailed object and simple numeric formats %]
[% BLOCK metrics_breakdown %]
  [% IF detailed %]
    [% IF metrics_1h.total %]
      [%# Detailed breakdown format using loops %]
      [% PROCESS define_metric_types %]
      [%
        periods = [
          { data = metrics_1h, label = '1 hour' },
          { data = metrics_24h, label = '24 hours' }
        ];
        FOREACH period IN periods;
          PROCESS format_time_period period = { label = period.label } period_data = period.data;
          IF !loop.last; '<br>'; END;
        END;
      %]
    [% ELSE %]
      [%# Simple numeric format %]
      <strong>1 hour:</strong> [% (metrics_1h || 0) | format('%.1f') %] tests/min<br>
      <strong>24 hours:</strong> [% (metrics_24h || 0) | format('%.1f') %] tests/min
    [% END %]
  [% ELSE %]
    [% (metrics_1h.total || 0) | format('%.1f') %] (1h), [% (metrics_24h.total || 0) | format('%.1f') %] (24h)
  [% END %]
[% END %]

[%# Display metrics error message %]
[% BLOCK metrics_error %]
  [% IF metrics && !metrics.success %]
    <div class="alert alert-warning">
      <small>
        Metrics: [% metrics.error | html %]
        [% IF metrics.trace_id %](Trace ID: [% metrics.trace_id | html %])[% END %]
      </small>
    </div>
  [% END %]
[% END %]
